<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" []>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc toc="yes"?>
<?rfc tocdepth="2"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc compact="yes" ?>
<rfc category="exp" docName="rfc-tos-specific"
ipr="trust200902" updates="6126">
<front>
<title>TOS-Specific Routing in Babel</title>
<author fullname="Gwendoline Chouasne" initials="G." surname="Chouasne">
<organization>PPS, University of Paris-Diderot</organization>
<address>
<postal>
<street>Case 7014</street>
<city>75205 Paris Cedex 13</city>
<region></region>
<code></code>
<country>France</country>
</postal>
<email>gwendoline.chouasne-guillon@ens.fr</email>
</address>
</author>
<author fullname="Juliusz Chroboczek" initials="J." surname="Chroboczek">
<organization>PPS, University of Paris-Diderot</organization>
<address>
<postal>
<street>Case 7014</street>
<city>75205 Paris Cedex 13</city>
<region></region>
<code></code>
<country>France</country>
</postal>
<email>jch@pps.univ-paris-diderot.fr</email>
</address>
</author>

<date day="10" month="May" year="2017"/>

<abstract>
<t>This document describes an extension to the Babel routing protocol to
support TOS-specific routing. This version is using mandatory sub-TLVs.</t>


</abstract>

</front>

<middle>

<section title="Introduction and background">

<t>The Type of Service (ToS) field defined in IPV4 is used to indicate
the type of routing a packet needs (for example, low-delay or high throughput).</t>

<t>This extension defines an extension to the base Babel protocol defined in 
<xref target="BABEL"/> to enable routers to route packets according to 
their ToS field.</t> [TODO ou alors faut-il seulement dire que les routeurs peuvent "apprendre" des routes, après ce qu'ils font c'est la couche du dessous)]

<t>Previous implementations of ToS-specific routing are described in <xref target="TOS-ROUTING"/></t>

</section>

<section title="Data Structures">

<t>This extension adds data in the structures maintained by Babel.</t>

<section title="The Source Table">

<t>Every Babel node maintains a source table, as described in <xref
target="BABEL"/>, Section 3.2.4.  A ToS-specific Babel node extends
this table with the following field:
<list style="symbols">
<t>the ToS specifying the source of packets to which this entry applies.</t>
</list>
If this is a non-ToS-specific entry, then the ToS is set to 0.

</section>

<section title="The Table of Pending Requests">

<t>Every Babel node maintains a table of pending requests, as described
in <xref target="BABEL"/>, Section 3.2.6.  A source-specific Babel node
extends this table with the following entry:
<list style="symbols">
<t>the ToS being requested.</t>
</list></t>

</section>

</section>

</section>

<section title="Data Forwarding">

<t>Traditionally, when a packet arrives to a node who has several suitable
routes, it chooses the one with the most specific prefix.</t>

<t>However, adding ToS into routes mean it could choose the route with the most
specific prefix and exact ToS. For example, suppose there is a route 
with ToS 8 for the prefix 192.168.5.0/24 and one with no ToS for the prefix 
192.168.0.0/16. A packet with 192.168.5.2 as destination matches both of
these routes, but none of them is more specific.</t>

<t>It is important that all routers use the same priority rules between 
destination and ToS to preserve loop-avoidance.</t>

[TODO à réécrire, c'est laborieux]
<t>A Babel implementation with this extension MUST choose the route with the 
destination-first ordering. This ordering considers first the routes with
the most specific prefixes, and then chooses among them the one with the
ToS of the packet. If it doesn't exist, then it gradually considers the
routes with the less specific prefixes, until it finds one with the required
ToS. </t>

<t>This means that a Babel implementation of this extension must ensure that
lower layers that forward packet observe these semantics. If it doesn't, 
the implementation MUST disambiguate the routing tables by using a suitable
argorithm (see <xref target="SS-ROUTING"/>)</t>

</section>

<section title="Protocol Operation">

<t>This extension does not fundamentally change the operation of the Babel
protocol.  We only described the fundamental differences between the
original protocol and the extension in this section.  The other mechanism
described in [BABEL] (Section 3) may be infered by using pairs of
(destination, source) prefixes instead of just (destination) prefixes.</t>

<section title="Updates">

<t>This extension introduces a new kind of update, the source-specific
update.  Whenever a source-specific Babel node needs to send an update, it
checks whether the update is for a source-specific route (a route with
a source prefix of non-zero length); if that is the case, it MUST send
a source-specific update (<xref target="ss-update"/>), and otherwise it
MUST send a non-specific update (<xref target="BABEL"/>, Section
4.4.9).</t>

<t>Every Babel node maintains a source table, which it updates whenever it
sends an Update (<xref target="BABEL"/>, Section 3.7.3).
A source-specific Babel node MUST update the source table not only when it
sends an update, but also when it sends a source-specific update.</t>

<section title="Encoding of Updates">

<t>Contrary to [BABEL] (see Section 3.5.3), this extension does not allow
to use address compression for source prefixes.  The compression of
destination prefixes is also limited: as a source-specific update TLV (an
Update TLV with source-specific AE values) is ignored by the original
Babel protocol, such update cannot be used to store a new destination
prefix.  However, source-specific updates can compress the destination
prefix using a previous non-specific update.</t>

<t>For the same reason, router-id can't be derived from a source-specific
update.</t>

<t>The encoding of updates is described in detail in <xref
target="encoding"/>.</t>

<t>REMARQUE: on pourrait compresser le prefixe source avec le prefixe
destination par defaut.  En pratique, dans un reseau multihome, les
prefixes sources seraient sans doute tous ommis.</t>

</section>

<section title="Route Acquisition">

<t>When a non-ToS-specific Babel node receives an update with a ToS-specific
sub-TLV, it will ignore it, according to the base protocol defined in <xref target="BABEL"/>.</t>

<t>When a ToS-specific Babel node receives a non-ToS-specific update, it
MUST consider it update as a ToS-specific update with ToS 0.</t>

</section>

</section>

<section title="Requests">

<t>Babel nodes send updates just as defined in the base protocol <xref target="BABEL"/>.
If a Babel node needs to send a request for a route with a certain ToS,
then it MUST send the request with the sub-TLV defined in this document.
If it is not, it MUST send the request without it.
</t>

</section>

</section>

<section title="Backwards compatibility">

<t>The protocol extension defined in this document is interoperable with
the base protocol defined in <xref target="BABEL"/>. In particular, 
Babel's loop-avoidance properties are preserved.
In the case of a topology with routers implementing ToS-specific Babel 
and non-ToS-specific Babel, all packets will reach their destination
if it is reachable. Non-ToS-specific packets will follow the same routes 
as if there was only non-ToS-specific routers. ToS-specific packets may
use non-ToS-specific routes if and only if there is no route for the ToS
they have. [est-ce qu'il faut mettre cette dernière phrase? ça dépend de la couche du dessous)

<section title="Loop-avoidance">

<t>This extension uses a mandatory bit on each sub-TLV. It is necessary 
that this bit is set to 1 for all ToS-specific sub-TLV to avoid loops.</t>

<t>As an example, consider two routers A and B, A implementing the 
ToS-specific Babel extension, and B implementing just the base Babel 
protocol. Suppose that B has a non-ToS specific default route through C, 
and A has a non-ToS-specific default route through D and a 
ToS-specific route for a prefix P and ToS t going through B like in the following figure. A will 
eventually send B an update for its ToS-specific route. Suppose that
B reads the update TLV but drops the ToS-specific sub-TLV and learns to 
forward packets for P through A. When a packet with ToS t arrives to A or B,
it would travel between A and B indefinitely.



<figure><artwork><![CDATA[
                        (P, t)             (::/0, 0)
                         -->                 -->
  D ------------------ A ----------------- B ----------------- C
                   <--
                 (::/0, 0)
]]></artwork></figure>

</section>

<section title="Protocol Encoding" anchor="encoding">

<t>This extension defines a new sub-TLV for turning regular Updates, Route Requests
and Seqno Requests [TODO seqno request?] into ToS-specific Updates, Route Requests
and Seqno Requests. Other TLVs MUST NOT use this sub-TLV, because they 
would get discarded by non-ToS-specific Babel nodes.</t>

<t>The new sub-TLV MUST be used by ToS-specific Update, Route Request
and Seqno Request, as defined in this document. It is defined as follow:

[TODO avec le mandatory bit]
<figure><artwork><![CDATA[
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  
]]></artwork></figure>

Following is the definition of the new Update, Route Request
and Seqno Request TLVs.
[TODO avec mandatory bit]
<section title="Update" anchor="ss-update">
<figure><artwork><![CDATA[
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type = 8    |    Length     |      AE       |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Plen     |    Omitted    |            Interval           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Seqno             |             Metric            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Source Plen  |        Prefix...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
|        Source prefix...
+-+-+-+-+-+-+-+-+-+-+-+-
]]></artwork></figure>

<t>All fields are unchanged.</t>

</section>

<section title="Route Request" anchor="ss-request">

<figure><artwork><![CDATA[
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type = 9    |    Length     |      AE       |      Plen     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Source Plen  |        Prefix...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
|        Source prefix...
+-+-+-+-+-+-+-+-+-+-+-+-
]]></artwork></figure>

<t>All fields are unchanged.</t>

</section>

<section title="Seqno Request">

<figure><artwork><![CDATA[
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type = 10   |    Length     |      AE       |      Plen     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Seqno             |   Hop Count   |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                           Router-Id                           +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Source Plen  |        Prefix...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
|        Source prefix...
+-+-+-+-+-+-+-+-+-+-+-+-
]]></artwork></figure>

<t>All fields are unchanged.</t>


[TODO il faut définir quoi faire en recevant une request]
<t>A Seqno Request with 4 or 5 AE values TLV prompts the receiving node to
send an Update for the route specified by the AE, Plen, Prefix, Source
Plen and Source Prefix fields, with either a router-id different from what
is specified by the Router-Id field, or a Seqno no less than what is
specified by the Seqno field.  If this request cannot be satisfied
locally, then it is forwarded according to the rules set out in Section
3.8.1.2 of <xref target="BABEL"/>.</t>

<t>Just like an ordinary Seqno Request, a Source-Specific Seqno Request
MAY be sent to a multicast address but MUST NOT be forwarded to
a multicast address and MUST NOT be forwarded to more than one neighbour.
A Source-Specific Seqno Request MUST NOT be forwarded if its Hop Count
field is 1.</t>

<t>AE values between 0 and 3 are defined in the original protocol.  This
extention defines values 4 and 5, respectively indicating that the prefixes
are IPv4 and IPv6.</t>

</section>

</section>

<section title="IANA Considerations">

[TODO je comprends pas quoi écrire]
<t>IANA is instructed to add the following entries to the "Babel AE"
registry:</t>

<texttable>
<ttcol>Type</ttcol><ttcol>Name</ttcol><ttcol>Reference</ttcol>
<c>4</c><c>Source-specific IPv4 prefixes</c><c>(this document)</c>
<c>5</c><c>Source-specific IPv6 prefixes</c><c>(this document)</c>
</texttable>

</section>

<section title="Security considerations">

<t>The extension defined in this protocol defines three new sub-TLVs for
defined TLVs. This extension doesn't alterate any of the security properties
of the base protocol.</t>

</section>

</middle>

<back>

<references title="Normative References">

<reference anchor="BABEL"><front>
<title>The Babel Routing Protocol</title>
<author fullname="Juliusz Chroboczek" initials="J." surname="Chroboczek"/>
<date month="February" year="2011"/>
</front>
<seriesInfo name="RFC" value="6126"/>
</reference>

<reference anchor="BABEL-EXT"><front>
<title>Extension Mechanism for the Babel Routing Protocol</title>
<author fullname="Juliusz Chroboczek" initials="J." surname="Chroboczek"/>
<date day="28" month="May" year="2015"/>
</front>
<seriesInfo name="RFC" value="7557"/>
</reference>

</references>

<references title="Informative References">

<reference anchor="TOS-ROUTING">
<front>
<title>ToS-Specific Routing</title>
<author initials="M." surname="Boutier" fullname="Matthieu Boutier"/>
<author initials="J." surname="Chroboczek" fullname="Juliusz Chroboczek"/>
<date year="2014" month="August"/>
</front>
<annotation>[TODO mettre un bo article qui parle de ToS]</annotation>
</reference>

</references>

</back>

</rfc>

